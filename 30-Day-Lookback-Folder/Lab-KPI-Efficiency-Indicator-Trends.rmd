---
title: "Laboratory Efficiency Indicators: 30 Day Lookback"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

<h4><span style = "color:red">Draft - Not For Distribution</h4></span style = "color:red">


```{r Install and load packages, echo = FALSE, warning = FALSE, message = FALSE}
#Install packages only the first time you run the code
#install.packages("timeDate")
#install.packages("lubridate")
#install.packages("readxl")
#install.packages("writexl")
#install.packages("dplyr")
#install.packages("reshape2")
#install.packages("knitr")
#install.packages("kableExtra")
#install.packages("formattable")
#install.packages("bizdays")
#install.packages("rmarkdown")
#install.packages("stringr")
#install.packages("tinytex")
#install.packages("scales")
#install.packages("gridExtra")
#install.packages("ggQC")


#-------------------------------Required packages------------------------------#

#Required packages: run these everytime you run the code
library(timeDate)
library(readxl)
library(bizdays)
library(dplyr)
library(lubridate)
library(reshape2)
library(knitr)
library(kableExtra)
library(formattable)
library(rmarkdown)
library(stringr)
library(writexl)
library(ggplot2)
library(gridExtra)
library(scales)
library(ggQC)
```


```{r global_options, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = TRUE, message = FALSE)
```


```{r Clear history and import relevant data, echo = FALSE, warning = FALSE, message = FALSE}

#Clear existing history
rm(list = ls())

# Select file/folder path for easier file selection and navigation
if ("Presidents" %in% list.files("J://")) {
  user_directory <- paste0("J:/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "Service Lines/Lab Kpi/Data")
} else {
  user_directory <- paste0("J:/deans/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "Service Lines/Lab Kpi/Data")
}

cp_user_path <- paste0(user_directory, "/CP Historical Repo/*.*")
ap_user_path <- paste0(user_directory, "/AP & Cytology Historical Repo/*.*")

# Import Clinical Pathology historical repository (Sunquest and SCC)
scc_sun_hist <-
  readRDS(file = choose.files(default = cp_user_path,
                              caption = "Select Historical Repository"))

# Import Anatomic Pathology historica repository (PowerPath)
ap_hist_repo <-
  readRDS(file =
    choose.files(default = ap_user_path,
                 caption = "Select Anatomic Pathology Historical Repository"))

# Determine start date based on lookback period and last date in repository
scc_sun_hist$ResultDate <- as.Date(scc_sun_hist$ResultDate, format = "%m/%d/%y")
lookback_period <- 30
start_date <- max(scc_sun_hist$ResultDate) - (lookback_period - 1)

# Sinai color scheme
mshs_colors = c("#221f72", "#00AEFF", "#D80B8C", "#7f7f7f")

```

```{r Reference Data, warning = FALSE, message = FALSE, echo = FALSE}
# Import analysis reference data
reference_file <- paste0(user_directory,
                         "/Code Reference/",
                         "Analysis Reference 2021-03-22.xlsx")

test_code <- read_excel(reference_file, sheet = "TestNames")
###this should be replaced by:
# CP and Micro --------------------------------
#scc_test_code <- read_excel(reference_file, sheet = "SCC_TestCodes")
#sun_test_code <- read_excel(reference_file, sheet = "SUN_TestCodes")

tat_targets <- read_excel(reference_file, sheet = "Turnaround Targets")
#
# Add a column concatenating test, priority, and setting for matching later
tat_targets <- tat_targets %>%
  mutate(Concate = ifelse(
    Priority == "All" & `Pt Setting` == "All", Test,
    ifelse(Priority != "All" & `Pt Setting` == "All", paste(Test, Priority),
           paste(Test, Priority, `Pt Setting`))))

scc_icu <- read_excel(reference_file, sheet = "SCC_ICU")
scc_setting <- read_excel(reference_file, sheet = "SCC_ClinicType")
sun_icu <- read_excel(reference_file, sheet = "SUN_ICU")
sun_setting <- read_excel(reference_file, sheet = "SUN_LocType")

mshs_site <- read_excel(reference_file, sheet = "SiteNames")

cp_micro_lab_order <- c("Troponin",
                        "Lactate WB",
                        "BUN",
                        "HGB",
                        "PT",
                        "Rapid Flu",
                        "C. diff")

site_order <- c("MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM", "MSSN")
city_sites <- c("MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")

pt_setting_order <- c("ED", "ICU", "IP Non-ICU", "Amb", "Other")
pt_setting_order2 <- c("ED & ICU", "IP Non-ICU", "Amb", "Other")
dashboard_pt_setting <- c("ED & ICU", "IP Non-ICU", "Amb")

dashboard_priority_order <- c("All", "Stat", "Routine")

#-----------Patient Setting Excel File-----------#
#Using Rev Center to determine patient setting
patient_setting <- data.frame(read_excel(reference_file,
                                         sheet = "AP_Patient Setting"),
                              stringsAsFactors = FALSE)

#-----------Anatomic Pathology Targets Excel File-----------#
tat_targets_ap <- data.frame(read_excel(reference_file,
                                     sheet = "AP_TAT Targets"),
                          stringsAsFactors = FALSE)

#-----------GI Codes Excel File-----------#
#Upload the exclusion vs inclusion criteria associated with the GI codes
gi_codes <- data.frame(read_excel(reference_file, sheet = "GI_Codes"),
                       stringsAsFactors = FALSE)

```

```{r Format historical repository for Clinical Pathology plotting, echo = FALSE, warning = FALSE, message = FALSE}
cp_dashboard_tat_summary <- scc_sun_hist %>%
  group_by(Site, ResultDate, Division, Test, 
           DashboardPriority, DashboardSetting, 
           ReceiveResultTarget, CollectResultTarget) %>%
  summarize(ResultedVolume = sum(TotalResulted), 
            ResultedVolumeWithTAT = sum(TotalResultedTAT), 
            ReceiveResultInTarget = sum(TotalReceiveResultInTarget), 
            CollectResultInTarget = sum(TotalCollectResultInTarget)) %>%
  mutate(ReceiveResultDefects = ResultedVolumeWithTAT - ReceiveResultInTarget,
         CollectResultDefects = ResultedVolumeWithTAT - CollectResultInTarget,
         ReceiveResultPercent = ReceiveResultInTarget / ResultedVolumeWithTAT,
         CollectResultPercent = CollectResultInTarget / ResultedVolumeWithTAT,
         SafeThreshold = ifelse(Test == "Rapid Flu" | Test == "C. diff", 1.0, 0.95),
         NotSafeThreshold = ifelse(Test == "Rapid Flu" | Test == "C. diff", 0.9, 0.8))

cp_dashboard_vol_summary <- scc_sun_hist %>%
  group_by(Site, ResultDate, Test, DashboardPriority) %>%
  summarize(ResultedVolume = sum(TotalResulted))

```

```{r Filter unused TAT combinations for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}
# Manually remove patient settings or combinations not represented in efficiency indicator dashboards
cp_dashboard_tat_filter <- cp_dashboard_tat_summary %>%
  filter(!(DashboardPriority == "Other" | DashboardSetting == "Other" | 
             ((Test == "Troponin" | Test == "Lactate WB") & DashboardSetting == "Amb") |
             (Test == "C. diff" & DashboardSetting == "Amb")))

# Convert characters to factors
cp_dashboard_tat_filter$Site <- factor(cp_dashboard_tat_filter$Site, levels = site_order)
cp_dashboard_tat_filter$Test <- factor(cp_dashboard_tat_filter$Test, levels = cp_micro_lab_order)
cp_dashboard_tat_filter$DashboardPriority <- factor(cp_dashboard_tat_filter$DashboardPriority, levels = dashboard_priority_order)
cp_dashboard_tat_filter$DashboardSetting <- factor(cp_dashboard_tat_filter$DashboardSetting, levels = dashboard_pt_setting)

# Sort data frame
cp_dashboard_tat_filter <- cp_dashboard_tat_filter %>%
  arrange(Test, Site, DashboardPriority, DashboardSetting, ResultDate)

```

```{r Custom function for graphing TAT percentage for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}
cp_tat_percentage_graph <- function(data, test_name, site_name, lab_priority, metric) {
  metric_name <- ifelse(metric == "ReceiveResultPercent", "Receive to Result TAT", ifelse(metric == "CollectResultPercent", "Collect to Result TAT", "Error"))
  # df <- data[data$ResultDate >= start_date & data$Test == test & data$Site == site & data$DashboardPriority == lab_priority, ]
  # 
  ggplot() +
    geom_rect(aes(xmin = start_date - 1, xmax = max(data$ResultDate) + 1, ymin = -Inf, ymax = min(data$NotSafeThreshold), fill = "Not Safe", alpha = "Not Safe")) +
    geom_rect(aes(xmin = start_date - 1, xmax = max(data$ResultDate) + 1, ymin = min(data$NotSafeThreshold), ymax = min(data$SafeThreshold), fill = "At Risk", alpha = "At Risk")) +
    geom_rect(aes(xmin = start_date - 1, xmax = max(data$ResultDate) + 1, ymin = min(data$SafeThreshold), ymax = Inf, fill = "Safe", alpha = "Safe")) +
    geom_point(data = data[data$ResultDate >= start_date & data$Test == test_name & data$Site == site_name & data$DashboardPriority == lab_priority, ], aes_string(x = "ResultDate", y = metric, color = "DashboardSetting", shape = "DashboardSetting"), size = 3) +
    geom_line(data = data[data$ResultDate >= start_date & data$Test == test_name & data$Site == site_name & data$DashboardPriority == lab_priority, ], aes_string(x = "ResultDate", y = metric, color = "DashboardSetting"), linetype = "dashed") +
    labs(title = paste0(test_name, " ", metric_name, ":\n", site_name, " Percentage of ", lab_priority, " Labs within Target"), x = "Date",  y = "Percentage of Labs", color = "Setting", shape = "Setting") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "right", legend.box = "vertical", legend.title = element_text(size = 10), legend.text = element_text(size = 8),axis.text.x = element_text(angle = 30, hjust = 1)) +
    scale_x_date(limits = c(start_date -1, max(data$ResultDate)+1), breaks = seq(start_date, max(data$ResultDate), by = 3), date_minor_breaks = "1 day", date_labels = "%m/%d/%y", expand = c(0, 0, 0, 0)) +
    scale_fill_manual(name = "Status", values = c("Not Safe" = "red", "At Risk" = "orange", "Safe" = "green"), breaks=c("Not Safe","At Risk","Safe")) +
    scale_alpha_manual(name = "Status", values = c("Not Safe" = 0.15, "At Risk" = 0.15, "Safe" = 0.15), breaks=c("Not Safe","At Risk","Safe")) +
    scale_color_manual(name = "Setting", values = mshs_colors)
}
```

```{r Custom function for graphing resulted lab volume stratified by order priority for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}

# Function for plotting total resulted lab volume stratified by order priority
cp_resulted_volume_graph <- function(data, test_name, site_name) {
  ggplot() +
    geom_point(data = data[data$ResultDate >= start_date & data$Test == test_name & data$Site == site_name, ], aes(x = ResultDate, y = ResultedVolume, color = DashboardPriority, shape = DashboardPriority), size = 3) +
    geom_line(data = data[data$ResultDate >= start_date & data$Test == test_name & data$Site == site_name, ], aes(x = ResultDate, y = ResultedVolume, color = DashboardPriority), linetype = "dashed") +
    labs(title = paste0(site_name, " ", test_name, " Resulted Lab Volume"), x = "Date",  y = "Volume of Labs", color = "Priority", shape = "Priority") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom", legend.box = "horizontal", legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8),axis.text.x = element_text(angle = 30, hjust = 1)) +
    scale_x_date(limits = c(start_date -1, max(data$ResultDate)+1), breaks = seq(start_date, max(data$ResultDate), by = 3), date_minor_breaks = "1 day", date_labels = "%m/%d/%y", expand = c(0, 0, 0, 0)) +
    # scale_y_continuous(sec.axis = sec_axis(~.*1, name = " ", breaks = NULL, label = NULL)) +
    scale_color_manual(name = "Priority", values = mshs_colors)
}
```

```{r Custom function for plotting TAT percentages and resulted volume on single graph for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}

cp_tat_and_volume_plot <- function(data_tat, test_name, site_name, lab_priority, metric) {
  # 
  # Subset turnaround time and volume data based on test, site, and priority
  data_tat_plot <- data_tat %>%
    filter(ResultDate >= start_date & 
             Test == test_name & 
             Site == site_name & 
             DashboardPriority == lab_priority)

  data_vol_plot <- cp_dashboard_vol_summary %>%
    filter(ResultDate >= start_date & 
             Test == test_name & 
             Site == site_name & 
             DashboardPriority == lab_priority)
  # 
  # Create printable metric name based on selected metric
  metric_name <- ifelse(metric == "ReceiveResultPercent", "Receive to Result", ifelse(metric == "CollectResultPercent", "Collect to Result", "Error"))
  #
  # Determine scale factor for secondary axis based on maximum resulted volume
  base10 <- floor(log10(max(data_vol_plot$ResultedVolume)))
  scale <- ceiling(max(data_vol_plot$ResultedVolume)/(10^(base10-1)))*10^(base10-1)
  #
  # Create plot and standard settings
  ggplot() +
    # Plot safe, at risk, not safe thresholds
    geom_rect(aes(xmin = start_date - 1, xmax = max(data_tat_plot$ResultDate) + 1, 
                  ymin = -Inf, ymax = min(data_tat_plot$NotSafeThreshold), 
                  fill = "Not Safe", alpha = "Not Safe")) +
    geom_rect(aes(xmin = start_date - 1, xmax = max(data_tat_plot$ResultDate) + 1, 
                  ymin = min(data_tat_plot$NotSafeThreshold), ymax = min(data_tat_plot$SafeThreshold), 
                  fill = "At Risk", alpha = "At Risk"), show.legend = FALSE) +
    geom_rect(aes(xmin = start_date - 1, xmax = max(data_tat_plot$ResultDate) + 1, 
                  ymin = min(data_tat_plot$SafeThreshold), ymax = 1, 
                  fill = "Safe", alpha = "Safe"), show.legend = FALSE) + 
    geom_rect(aes(xmin = start_date - 1, xmax = max(data_tat_plot$ResultDate) + 1, 
                  ymin = 1, ymax = Inf, fill = "N/A", 
                  alpha = "N/A"), show.legend = FALSE) +
    # Plot percentage of labs within turnaround time target
    geom_point(data = data_tat_plot, aes_string(x = "ResultDate", y = metric, color = "DashboardSetting", shape = "DashboardSetting"), size = 3) +
    geom_line(data = data_tat_plot, aes_string(x = "ResultDate", y = metric, color = "DashboardSetting"), linetype = "dashed") +
    # Plot resulted volume on secondary axis
    geom_point(data = data_vol_plot, aes(x = ResultDate, y = ResultedVolume/scale, size = "Volume"), color = "#959595", shape = 18) +
    geom_line(data = data_vol_plot, aes(x = ResultDate, y = ResultedVolume/scale, linetype = "Volume"), color = "#959595") +
    # Specify graph labels and themes
    labs(title = paste0(site_name, " ", test_name, " ", metric_name, ":\n", "Percentage of ", lab_priority, " Labs within Target TAT"), 
         x = "Date",  y = "Percentage of Labs", color = "Setting", shape = "Setting", fill = "Status", alpha = "Status", linetype = "Resulted Volume", size = "Resulted Volume") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom", legend.box = "horizontal", 
          legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8),
          axis.text.x = element_text(angle = 30, hjust = 1)) +
    # Specify fills, shapes, and lines mappings and legends
    scale_fill_manual(name = "Status", values = c("Not Safe" = "red", "At Risk" = "orange", "Safe" = "green", "N/A" = "grey"), 
                      breaks=c("Not Safe","At Risk","Safe")) +
    scale_alpha_manual(name = "Status", values = c("Not Safe" = 0.25, "At Risk" = 0.25, "Safe" = 0.25, "N/A" = 0.5), 
                       breaks=c("Not Safe","At Risk","Safe")) +
    scale_color_manual(name = "Setting", values = mshs_colors) +
    scale_size_manual(name = "Resulted Volume", values = 2, labels = paste(lab_priority, "Labs, \n All Settings")) + 
    scale_linetype_manual(name = "Resulted Volume", values = "dotted", labels = paste(lab_priority, "Labs, \n All Settings")) +
    # Reorder legends
    guides(color = guide_legend(order = 1, nrow = length(unique(data_tat_plot$DashboardSetting)), title.vjust = 1), shape = guide_legend(order = 1, nrow = length(unique(data_tat_plot$DashboardSetting)), title.vjust = 1), fill = guide_legend(order = 3, nrow = 3, title.vjust = 1), alpha = guide_legend(order = 3, nrow = 3, title.vjust = 1), 
           size = guide_legend(order = 2, title.vjust = 1), linetype = guide_legend(order = 2, title.vjust = 1)) +
    # Specify axis properties
    scale_x_date(limits = c(start_date -1, max(data_tat_plot$ResultDate)+1), 
                 breaks = seq(start_date, max(data_tat_plot$ResultDate), by = 3), date_minor_breaks = "1 day", 
                 date_labels = "%m/%d/%y", expand = c(0, 0, 0, 0)) +
    scale_y_continuous(limits = c(0, 1), breaks = seq(from = 0, to = 1, length.out = 5), expand = c(0, 0, 0.05, 0), labels = percent_format(accuracy = 1), 
                       sec.axis = sec_axis(~.*scale, name = "Volume of Labs"))
}
```

```{r Custom function for stepping through stratified TAT data for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}
cp_stratified_data_for_plots <- function(tat_data, test) {
  test_df <- tat_data %>% 
    filter(Test == test,
           ResultDate >= start_date)
  sites <- unique(test_df$Site)
  for (site in sites) {
    site_df <- test_df %>%
      filter(Site == site)
    priorities <- unique(site_df$DashboardPriority)
    for (priority in priorities) {
      priority_df <- site_df %>%
        filter(DashboardPriority == priority)
      # print(tat_percentage_graph(data = priority_df, test_name = test, site_name = site, lab_priority = priority, metric = "ReceiveResultPercent"))
      # print(tat_percentage_graph(data = priority_df, test_name = test, site_name = site, lab_priority = priority, metric = "CollectResultPercent"))
      print(cp_tat_and_volume_plot(data_tat = priority_df, test_name = test, site_name = site, lab_priority = priority, metric = "ReceiveResultPercent"))
      print(cp_tat_and_volume_plot(data_tat = priority_df, test_name = test, site_name = site, lab_priority = priority, metric = "CollectResultPercent"))
      }
    print(cp_resulted_volume_graph(data = cp_dashboard_vol_summary, test_name = test, site_name = site))
  }
}
```

```{r Summarize data to calculate defects and defect rates for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}

# Summarize data based on site and priority
cp_dashboard_defect_summary <- cp_dashboard_tat_filter %>%
  group_by(Site, ResultDate, Division, Test, DashboardPriority) %>%
  summarize(ResultedVolume = sum(ResultedVolume), 
            ResultedVolumeWithTAT = sum(ResultedVolumeWithTAT),
            ReceiveResultInTarget = sum(ReceiveResultInTarget), 
            CollectResultInTarget = sum(CollectResultInTarget),
            ReceiveResultDefects = ResultedVolumeWithTAT - ReceiveResultInTarget, 
            ReceiveResultDefectRate = ReceiveResultDefects / ResultedVolumeWithTAT)

cp_dashboard_defect_summary <- cp_dashboard_defect_summary[!is.na(cp_dashboard_defect_summary$ReceiveResultDefectRate), ]
```

```{r Custom function for p-charts for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}

cp_receive_result_pchart <- function(data_defect, test_name, site_name, lab_priority) {
  # 
  # Subset turnaround time and volume data based on test, site, and priority
  data_defect_plot <- data_defect %>%
    filter(ResultDate >= start_date & 
             Test == test_name & 
             Site == site_name & 
             DashboardPriority == lab_priority)
  # Calculate center line
  center_line <- mean(QC_Lines(data = data_defect_plot$ReceiveResultDefectRate, n = data_defect_plot$ResultedVolumeWithTAT, method = "p")$pBar)
  # 
  # Create plot and standard settings
  ggplot(data = data_defect_plot, aes(x = ResultDate, y = ReceiveResultDefectRate, n = ResultedVolumeWithTAT)) +
  # Create point and connecting lines for defect rate data
  geom_point(color = mshs_colors[1], shape = 16, size = 3) +
  geom_line(color = mshs_colors[1], linetype = "dashed") +
  # Add centerline, upper, and lower control limit lines
  stat_QC(method = "p", auto.label = T, color.qc_center = "black") +
  geom_label(x = max(data_defect_plot$ResultDate)+1, y = center_line, vjust = 1.2, hjust = 1, label = paste("CL:", percent(center_line, accuracy = 0.1))) +
  # Specify graph labels and themes
  labs(title = paste(site_name, test_name, lab_priority, "Labs:\n", "Control Chart of Non-Compliant Receive to Result TAT"), x = "Date",  y = "Percent Non-Compliant") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom", legend.box = "horizontal", 
          legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8),
          axis.text.x = element_text(angle = 30, hjust = 1)) +
  # Specify axis properties
  scale_x_date(limits = c(start_date -1, max(data_defect_plot$ResultDate)+1), breaks = seq(start_date, max(data_defect_plot$ResultDate), by = 3), date_minor_breaks = "1 day", date_labels = "%m/%d/%y", expand = c(0, 0, 0, 0)) +
  scale_y_continuous(labels = percent_format(accuracy = 1))
}


```

```{r Iterate through defect rate data and plot p-charts for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}

cp_stratified_data_for_pcharts <- function(defect_data, test) {
  test_df <- defect_data %>%
    filter(Test == test & 
             ResultDate >= start_date)
  sites <- unique(test_df$Site)

  for (site in sites) {
    # print(site)
    # print(test)
    site_df <- test_df %>%
      filter(Site == site)
    priorities <- unique(site_df$DashboardPriority)
    for (priority in priorities) {
      # print(priority)
      priority_df <- site_df %>%
        filter(DashboardPriority == priority)
      # Determine average resulted volume over last 30 days to see if p-chart is valid
      avg_resulted_volume <- mean(priority_df$ResultedVolumeWithTAT[priority_df$ResultDate >= start_date])
      # print(avg_resulted_volume)
      if (avg_resulted_volume >= 50) {
        print(cp_receive_result_pchart(data_defect = priority_df, test_name = test, site_name = site, lab_priority = priority))
      } else {
        cat(paste('\n<center><h3><i>', site, test, priority, "Labs: Insufficient volume for this analysis (n<50).</h3> \n <h4>(Average resulted volume over last 30 days:", round(avg_resulted_volume, digits = 0), "specimens.)", '</i></h4></center>\n\n<br><br>'))
      }
    }
  }
}

```

```{r Format Anatomic Pathology historical repository for plotting, warning = FALSE, message = FALSE, echo = FALSE}
#Exclude weekends
ap_hist_repo_wkdy <-
  ap_hist_repo[which(
    ap_hist_repo$Signed_out_day_only != "Sunday" &
      ap_hist_repo$Signed_out_day_only != "Saturday" &
      ap_hist_repo$Patient_setting != "NA"), ]

# Convert characters to factors
ap_hist_repo_wkdy <- ap_hist_repo_wkdy %>%
  mutate(Signed_out_date_only = as.Date(Signed_out_date_only)) %>%
  mutate(Lab_metric_within_target = as.numeric(Lab_metric_within_target)) %>%
  mutate(Patient_metric_avg = as.numeric(Patient_metric_avg)) %>%
  mutate(Lab_metric_avg = as.numeric(ap_hist_repo_wkdy$Lab_metric_avg))

#Calculate the total none defects
ap_hist_repo_wkdy <- ap_hist_repo_wkdy %>%
  mutate(total_none_defects =
           round(Lab_metric_within_target * No_cases_signed_out))

#Calculate the total defects
ap_hist_repo_wkdy <- ap_hist_repo_wkdy %>%
  mutate(total_defects = No_cases_signed_out - total_none_defects)

#Standardize Facility name 
ap_hist_repo_wkdy <- ap_hist_repo_wkdy %>%
  mutate(Facility_Old = Facility)

ap_hist_repo_wkdy$Facility[ap_hist_repo_wkdy$Facility == "BIMC"] <- "MSBI"
ap_hist_repo_wkdy$Facility[ap_hist_repo_wkdy$Facility == "R"] <- "MSW"
ap_hist_repo_wkdy$Facility[ap_hist_repo_wkdy$Facility == "SL"] <- "MSSL"
ap_hist_repo_wkdy$Facility[ap_hist_repo_wkdy$Facility == "KH"] <- "MSB"

#Add an extra column to change the facilities for GYN and CYTO GYN
#for receive to result to Centralized Lab
ap_hist_repo_wkdy <- ap_hist_repo_wkdy %>%
  mutate(New_Facility_rtr_CYTO = Facility)

ap_hist_repo_wkdy[
  (ap_hist_repo_wkdy$Spec_group == "CYTO GYN" |
     ap_hist_repo_wkdy$Spec_group == "CYTO NONGYN"), ]$New_Facility_rtr_CYTO <-
  "Centralized Lab"

ap_site_order <-
  c("MSH", "MSQ", "MSBI", "PACC", "MSB", "MSW", "MSSL", "NYEE")
ap_site_order_rtr <-
  c("Centralized Lab",
    "MSH", "MSQ", "MSBI","PACC", "MSB", "MSW", "MSSL", "NYEE")

ap_hist_repo_wkdy <- ap_hist_repo_wkdy %>%
   mutate(Facility = factor(Facility , levels = ap_site_order))

ap_hist_repo_wkdy <- ap_hist_repo_wkdy %>%
  mutate(New_Facility_rtr_CYTO = factor(New_Facility_rtr_CYTO,
                                        levels = ap_site_order_rtr ))

#determine the 30 business that will be reported
ap_unique_dates <- unique(ap_hist_repo_wkdy$Signed_out_date_only)

ap_ordered_dates <- ap_unique_dates[rev(order(ap_unique_dates))]

ap_reporting_30_day_period <- ap_ordered_dates[1:30]
ap_first_day_in_reporting_period <- ap_ordered_dates[30] 
ap_last_day_in_reporting_period <- ap_ordered_dates[1]

ap_hist_30_day <-
  ap_hist_repo_wkdy[
    which(
      ap_hist_repo_wkdy$Signed_out_date_only >=
        ap_first_day_in_reporting_period), ]

#summarized the data to plot it correctly
ap_hist_30_day_rtr <-
  summarise(group_by(ap_hist_30_day,
                     Signed_out_date_only,
                     Spec_group,
                     New_Facility_rtr_CYTO,
                     Patient_setting),
            Lab_metric_within_target =
              format(round(mean(as.numeric(Lab_metric_within_target),
                                na.rm = TRUE), 2)),
            Patient_metric_avg =
              format(round(mean(as.numeric(Patient_metric_avg),
                                na.rm = TRUE),0)),
            No_cases_signed_out = sum(No_cases_signed_out))

ap_hist_30_day_rtr[c("Lab_metric_within_target",
                     "Patient_metric_avg",
                     "No_cases_signed_out")] <-
  lapply(ap_hist_30_day_rtr[c("Lab_metric_within_target",
                              "Patient_metric_avg",
                              "No_cases_signed_out")], as.numeric)

ap_hist_30_day_ctr <-
  summarise(group_by(ap_historical_30_day_period,
                     Signed_out_date_only,
                     Spec_group,
                     Facility,
                     Patient_setting),
            Lab_metric_within_target =
              format(round(mean(as.numeric(Lab_metric_within_target),
                                na.rm = TRUE), 2)),
            Patient_metric_avg =
              format(round(mean(as.numeric(Patient_metric_avg),
                                na.rm = TRUE),0)),
            No_cases_signed_out = sum(No_cases_signed_out))

ap_hist_30_day_ctr[c("Lab_metric_within_target",
                     "Patient_metric_avg",
                     "No_cases_signed_out")] <-
  lapply(ap_hist_30_day_ctr[c("Lab_metric_within_target",
                              "Patient_metric_avg",
                              "No_cases_signed_out")], as.numeric)

ap_hist_30_day_vol <-
  summarise(group_by(ap_historical_30_day_period,
                     Signed_out_date_only,
                     Spec_group,
                     New_Facility_rtr_CYTO),
            No_cases_signed_out = sum(No_cases_signed_out))

ap_hist_30_day_vol_ctr <-
  summarise(group_by(ap_historical_30_day_period,
                     Signed_out_date_only,
                     Spec_group,
                     Facility),
            No_cases_signed_out = sum(No_cases_signed_out))

```


```{r Anatomic Pathology: plot volume and % TAT within target, warning = FALSE, message = FALSE, echo = FALSE}

#we need to create a percent within target graph for cyto and patho
#the graph will have the split between IP and AMB

ap_tat_vol_plot <-
  function(ap_hist_30_day_rtr,
           ap_hist_30_day_vol,
           test_name,
           site_name,
           metric) {

    ap_data_tat <-
      ap_hist_30_day_rtr[
        ap_hist_30_day_rtr$Spec_group == test_name &
          ap_hist_30_day_rtr$New_Facility_rtr_CYTO == site_name, ]
  
  ap_data_vol <-
    ap_hist_30_day_vol[
      ap_hist_30_day_vol$Spec_group == test_name &
        ap_hist_30_day_vol$New_Facility_rtr_CYTO == site_name, ]
 
  # Create printable metric name based on selected metric
  metric_name <-
    ifelse(metric == "Lab_metric_within_target", "Receive to Result",
           ifelse(metric == "Patient_metric_avg", "Collect to Result", "Error"))

  # Create printable test name based on selected test
  test_name <-
    ifelse(test_name == "Breast", "All Breast Specimen",
           ifelse(metric == "GI", "GI Biopsies", test_name))
  
ggplot() +
  # Plot safe, at risk, not safe thresholds
  geom_rect(aes(xmin = ap_first_day_in_reporting_period - 1,
                xmax = ap_last_day_in_reporting_period + 1,
                ymin = -Inf,
                ymax = 0.8,
                fill = "Not Safe",
                alpha = "Not Safe")) +
  geom_rect(aes(xmin = ap_first_day_in_reporting_period - 1,
                xmax = ap_last_day_in_reporting_period + 1,
                ymin = 0.8,
                ymax = 0.9,
                fill = "At Risk",
                alpha = "At Risk")) +
  geom_rect(aes(xmin = ap_first_day_in_reporting_period - 1,
                xmax = ap_last_day_in_reporting_period + 1,
                ymin = 0.9,
                ymax = Inf,
                fill = "Safe",
                alpha = "Safe")) +  
  geom_rect(aes(xmin = ap_first_day_in_reporting_period - 1,
                xmax = ap_last_day_in_reporting_period + 1,
                ymin = 0.9, ymax = Inf,
                fill = "N/A",
                alpha = "N/A"), show.legend = FALSE) + 

  # Plot resulted volume on secondary axis
  geom_point(data = ap_data_vol,
             aes(x = Signed_out_date_only,
                 y = No_cases_signed_out / max(No_cases_signed_out),
                 size = "Spec_group"),
             shape = 18,
             color = "#959595") +
  geom_line(data = ap_data_vol,
            aes(x = Signed_out_date_only,
                y = No_cases_signed_out / max(No_cases_signed_out),
                linetype = "Spec_group"),
            color = "#959595") +

  # Plot percentage of labs within turnaround time target
  geom_point(data = ap_data_tat,
             aes_string(x = "Signed_out_date_only",
                        y = metric,
                        shape = "Patient_setting",
                        color = "Patient_setting"),
             size = 3) +
  geom_line(data = ap_data_tat,
            aes_string(x = "Signed_out_date_only",
                       y = metric,
                       shape = "Patient_setting",
                       color = "Patient_setting"),
            linetype = "dashed") +
  
  # Specify graph labels and themes
  labs(title = paste0(site_name,
                      " ",
                      test_name,
                      " ",
                      metric_name,
                      ":\n", "Percentage of Labs within Target TAT"), 
       x = "Date",
       y = "Percentage of Labs",
       color = "Setting",
       shape = "Setting",
       fill = "Status",
       alpha = "Status",
       linetype = "Resulted Volume",
       size = "Resulted Volume") +
  
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.box = "horizontal", 
        legend.title = element_text(size = 8, face = "bold"),
        legend.text = element_text(size = 8),
        axis.text.x = element_text(angle = 30, hjust = 1)) +
 
  # Specify fills, shapes, and lines mappings and legends
  scale_fill_manual(name = "Status",
                    values = c("Not Safe" = "red",
                               "At Risk" = "orange",
                               "Safe" = "green",
                               "N/A" = "grey"),
                    breaks = c("Not Safe", "At Risk", "Safe")) +
  scale_alpha_manual(name = "Status",
                     values = c("Not Safe" = 0.25,
                                "At Risk" = 0.25,
                                "Safe" = 0.25,
                                "N/A" = 0.5),
                     breaks = c("Not Safe", "At Risk", "Safe")) +
  
  scale_color_manual(name = "Setting",
                     values = mshs_colors) +
  scale_size_manual(name = "Resulted Volume",
                    values = 2,
                    labels = paste("All Labs, \n All Settings")) + 
  scale_linetype_manual(name = "Resulted Volume",
                        values = "dotted",
                        labels = paste("All Labs, \n All Settings")) +
  
  # Reorder legends
  guides(color =
           guide_legend(order = 1,
                        nrow = length(unique(ap_data_tat$Patient_setting)),
                        title.vjust = 1),
         shape =
           guide_legend(order = 1,
                        nrow = length(unique(ap_data_tat$Patient_setting)),
                        title.vjust = 1),
         fill = guide_legend(order = 3, nrow = 3, title.vjust = 1),
         alpha = guide_legend(order = 3, nrow = 3, title.vjust = 1),
         size = guide_legend(order = 2, title.vjust = 1),
         linetype = guide_legend(order = 2, title.vjust = 1)) +
  
  # Specify axis properties
  scale_x_date(name = "Date",
               labels = date_format("%m/%d/%Y"),
               limits =
                 c(ap_first_day_in_reporting_period - 1,
                   ap_last_day_in_reporting_period + 1),
               date_breaks = "3 days",
               date_minor_breaks = "1 day",
               expand = c(0, 0, 0, 0)) +
  scale_y_continuous(name = "Percentage of Labs",
                     limits = c(0, 1),
                     labels = percent,
                     sec.axis =
                       sec_axis(~.*max(ap_data_vol$No_cases_signed_out),
                                name = "Volume of Labs"))
}

```


```{r Anatomic Pathology: Avg TAT for patient metric, warning = FALSE, message = FALSE, echo = FALSE}

#we need to create a percent within target graph for cyto and patho
#the graph will have the split between IP and AMB

ap_pat_tat_plot <-
  function(ap_hist_30_day_ctr,
           ap_hist_30_day_vol_ctr,
           test_name,
           site_name, metric) {
  
  ap_data_tat <-
    ap_hist_30_day_ctr[
      ap_hist_30_day_ctr$Spec_group == test_name &
        ap_hist_30_day_ctr$Facility == site_name, ]
  
  ap_data_vol <-
    ap_hist_30_day_vol_ctr[
      ap_hist_30_day_vol_ctr$Spec_group == test_name &
        ap_hist_30_day_vol_ctr$Facility == site_name, ]
  
  # Create printable metric name based on selected metric
  metric_name <-
    ifelse(metric == "Lab_metric_within_target", "Receive to Result",
           ifelse(metric == "Patient_metric_avg", "Collect to Result", "Error"))

  # Create printable test name based on selected test
  test_name <- ifelse(test_name == "Breast", "All Breast Specimen",
                      ifelse(test_name == "GI", "GI Biopsies", test_name))

  ggplot() +
  # Plot resulted volume on secondary axis
  geom_point(data = ap_data_vol,
             aes(x = Signed_out_date_only,
                 y = No_cases_signed_out / mean(No_cases_signed_out),
                 size = "Spec_group"),
             shape = 18,
             color = "#959595") +
  geom_line(data = ap_data_vol,
            aes(x = Signed_out_date_only,
                y = No_cases_signed_out / mean(No_cases_signed_out),
                linetype = "Spec_group"),
            color = "#959595") +

  # Plot Average lab metric TAT
  geom_point(data = ap_data_tat,
             aes_string(x = "Signed_out_date_only",
                        y = metric,
                        shape = "Patient_setting",
                        color = "Patient_setting"),
             size = 3) +
  geom_line(data = ap_data_tat,
            aes_string(x = "Signed_out_date_only",
                       y = metric,
                       shape = "Patient_setting",
                       color = "Patient_setting"),
            linetype = "dashed") +
  
  # Specify graph labels and themes
  labs(title =
         paste0(site_name,
                " ",
                test_name,
                " ",
                metric_name,
                ":\n","Average TAT (Days)"), 
       x = "Date",
       y = "Percentage of Labs",
       color = "Setting",
       shape = "Setting",
       linetype = "Resulted Volume",
       size = "Resulted Volume") +
  
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.box = "horizontal", 
        legend.title = element_text(size = 8, face = "bold"),
        legend.text = element_text(size = 8),
        axis.text.x = element_text(angle = 30, hjust = 1)) +

  # Specify fills, shapes, and lines mappings and legends
  scale_color_manual(name = "Setting",
                     values = mshs_colors) +
  scale_size_manual(name = "Resulted Volume",
                    values = 2,
                    labels = paste("All Labs, \n All Settings")) + 
  scale_linetype_manual(name = "Resulted Volume",
                        values = "dotted",
                        labels = paste("All Labs, \n All Settings")) +

  # Reorder legends
  guides(color =
           guide_legend(order = 1,
                        nrow = length(unique(ap_data_tat$Patient_setting)),
                        title.vjust = 1),
         shape =
           guide_legend(order = 1,
                        nrow = length(unique(ap_data_tat$Patient_setting)),
                        title.vjust = 1),
         size = guide_legend(order = 2, title.vjust = 1),
         linetype = guide_legend(order = 2, title.vjust = 1)) +
  
  # Specify axis properties
  scale_x_date(name = "Date",
               labels = date_format("%m/%d/%Y"),
               limits =
                 c(ap_first_day_in_reporting_period - 1,
                   ap_last_day_in_reporting_period + 1),
               date_breaks = "3 days",
               date_minor_breaks = "1 day",
               expand = c(0, 0, 0, 0)) +
  
  scale_y_continuous(name = "Average TAT (Days)",
                     limits =
                       c(0, max(ap_data_tat$Patient_metric_avg + 1)),
                     sec.axis =
                       sec_axis(~.*mean(ap_data_vol$No_cases_signed_out),
                                name = "Volume of Labs"))

}

```


```{r Custom function for graphing resulted lab volume, echo = FALSE, warning = FALSE, message = FALSE}

# Function for plotting total resulted lab volume
ap_resulted_vol_graph <-
  function(ap_hist_30_day_vol,
           test_name,
           site_name) {
  
  ap_data_vol <-
    ap_hist_30_day_vol[
      ap_hist_30_day_vol$Spec_group == test_name &
        ap_hist_30_day_vol$New_Facility_rtr_CYTO == site_name, ]

  # Create printable test name based on selected test
  test_name <- ifelse(test_name == "Breast", "All Breast Specimen",
                      ifelse(test_name == "GI", "GI Biopsies", test_name))

  ggplot() +
    geom_point(data = ap_data_vol,
               aes(x = Signed_out_date_only,
                   y = No_cases_signed_out,
                   size = "Spec_group"),
               shape = 16,
               color = mshs_colors[1]) +
    geom_line(data = ap_data_vol,
              aes(x = Signed_out_date_only,
                  y = No_cases_signed_out,
                  linetype = "Spec_group"),
              color = mshs_colors[1]) +
    labs(title =
           paste0(site_name,
                  " ",
                  test_name,
                  " Resulted Lab Volume"),
         x = "Date",
         y = "Volume of Labs",
         color = "Setting",
         shape = "Setting") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
          legend.position = "bottom",
          legend.box = "horizontal",
          legend.title = element_text(size = 8, face = "bold"),
          legend.text = element_text(size = 8),
          axis.text.x = element_text(angle = 30, hjust = 1)) +
    scale_x_date(name = "Date",
                 labels = date_format("%m/%d/%Y"),
                 limits =
                   c(ap_first_day_in_reporting_period - 1,
                     ap_last_day_in_reporting_period + 1),
                 date_breaks = "3 days",
                 date_minor_breaks = "1 day",
                 expand = c(0, 0, 0, 0)) +
    scale_size_manual(name = "Resulted Volume",
                      values = 2,
                      labels = paste("All Labs, \n All Settings")) + 
    scale_linetype_manual(name = "Resulted Volume",
                          values = "dotted",
                          labels = paste("All Labs, \n All Settings")) +
    scale_y_continuous(limits =
                         c(min(ap_data_vol$No_cases_signed_out - 1),
                           max(ap_data_vol$No_cases_signed_out + 1)))
}

```

```{r function to go through all the facilities for each test, warning = FALSE, message = FALSE, echo = FALSE}

ap_strat_data <-
  function(ap_hist_30_day_rtr,
           ap_hist_30_day_ctr,
           ap_hist_30_day_vol,
           test_name) {
  
  sites_rtr <-
    unique(
      ap_hist_30_day_rtr[ap_hist_30_day_rtr$Spec_group ==
                           test_name, ]$New_Facility_rtr_CYTO)
  
  sites_ctr <-
    unique(
      ap_hist_30_day_ctr[ap_hist_30_day_ctr$Spec_group ==
                           test_name, ]$Facility)

  for (site_rtr in sites_rtr) {
    print(
      ap_tat_vol_plot(ap_hist_30_day_rtr = ap_hist_30_day_rtr,
                      ap_hist_30_day_vol = ap_hist_30_day_vol,
                      test_name = test_name,
                      site_name = site_rtr,
                      metric = "Lab_metric_within_target"))
  }
  
  for (site_ctr in sites_ctr) {
    print(
      ap_pat_tat_plot(ap_hist_30_day_ctr = ap_hist_30_day_ctr,
                      ap_hist_30_day_vol_ctr = ap_hist_30_day_vol_ctr,
                      test_name = test_name,
                      site_name = site_ctr,
                      metric = "Patient_metric_avg"))
  }

  for (site_rtr in sites_rtr) {
    print(
      ap_resulted_vol_graph(ap_hist_30_day_vol = ap_hist_30_day_vol,
                            test_name = test_name,
                            site_name = site_rtr))
  }
}


```



```{r summarize data to calculate defects and defect rates for anatomic pathology, warning = FALSE, message = FALSE, echo = FALSE}

ap_hist_30_day_defects <-
  summarise(group_by(ap_historical_30_day_period,
                     Signed_out_date_only,
                     Spec_group,
                     New_Facility_rtr_CYTO),
            No_cases_signed_out = sum(No_cases_signed_out),
            total_none_defects = sum(total_none_defects),
            total_defects = sum(total_defects),
            defective_rate = total_defects / No_cases_signed_out)

```

```{r function for defective rate p-charts for anatomic pathology, echo = FALSE, warning = FALSE, message = FALSE}
ap_pchart <- function(ap_hist_30_day_defects, test_name, site_name) {
  
  ap_data_defc <-
    ap_hist_30_day_defects[
      ap_hist_30_day_defects$Spec_group == test_name &
        ap_hist_30_day_defects$New_Facility_rtr_CYTO == site_name, ]
  
  # Create printable test name based on selected test
  test_name <- ifelse(test_name == "Breast", "All Breast Specimen",
                      ifelse(test_name == "GI", "GI Biopsies", test_name))
   
  # Find the center line for the p-chart using QC_lines 
  center_line <-
    mean(QC_Lines(data = ap_data_defc$defective_rate,
                  n = ap_data_defc$No_cases_signed_out,
                  method = "p")$pBar)
  
  # Create plot and standard settings
  ggplot(data = ap_data_defc,
         aes(x = Signed_out_date_only,
             y = defective_rate,
             n = No_cases_signed_out)) +
  # Create point and connecting lines for defect rate data
  geom_point(color = mshs_colors[1], shape = 16, size = 3) +
  geom_line(color = mshs_colors[1], linetype = "dashed") +
  
  # Add centerline, upper, and lower control limit lines
  stat_QC(method = "p",
          auto.label = TRUE,
          color.qc_center = "black",
          limit.txt.label = c("LCL", "UCL")) +
  geom_label(x = max(ap_data_defc$Signed_out_date_only) + 1,
             y = center_line,
             vjust = 1.2,
             hjust = 1,
             label = paste("CL:", percent(center_line, accuracy = 0.1))) +
  # Specify graph labels and themes
  labs(title =
         paste(site_name,
               test_name,
               "All Labs:\n",
               "Control Chart of Non-Compliant Receive to Result TAT"),
       x = "Date",
       y = "Percent Non-Compliant") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.box = "horizontal",
        legend.title = element_text(size = 8, face = "bold"),
        legend.text = element_text(size = 8),
        axis.text.x = element_text(angle = 30, hjust = 1)) +
  # Specify axis properties
  scale_x_date(limits =
                 c(ap_first_day_in_reporting_period - 1,
                   max(ap_data_defc$Signed_out_date_only) + 1),
               breaks = seq(ap_first_day_in_reporting_period,
                            max(ap_data_defc$Signed_out_date_only), by = 3),
               date_minor_breaks = "1 day",
               date_labels = "%m/%d/%y",
               expand = c(0, 0, 0, 0)) +
  scale_y_continuous(labels = percent_format(accuracy = 1))
}

```

```{r function to go through all the facilities for each test for the p-chart, warning = FALSE, message = FALSE, echo = FALSE, results = 'asis'}

ap_strat_data_pchart <- function(ap_hist_30_day_defects, test_name) {
  
  sites <- unique(
    ap_hist_30_day_defects[
      ap_hist_30_day_defects$Spec_group == test_name, ]$New_Facility_rtr_CYTO)
    
  for (site in sites) {
    
    ap_avg_resulted_volume <-
      mean(
        ap_hist_30_day_defects[
          (ap_hist_30_day_defects$New_Facility_rtr_CYTO == site &
             ap_hist_30_day_defects$Spec_group ==
             test_name), ]$No_cases_signed_out)
    
    if (ap_avg_resulted_volume >= 50) {
      print(
        ap_pchart(ap_hist_30_day_defects = ap_hist_30_day_defects,
                  test_name = test_name,
                  site_name = site))
    }
    else{
      # Create printable test name based on selected test
      test_name_new <- ifelse(test_name == "Breast",
                              "All Breast Specimen",
                              ifelse(test_name == "GI",
                                     "GI Biopsies", test_name))
      cat(paste('\n<center><h3><i>',
                site, test_name_new,
                paste("Labs: Insufficient volume for this analysis (n<50).",
                "</h3>\n <h4>(Average resulted volume over last 30 days:"),
                round(ap_avg_resulted_volume, digits = 0), "specimens.)",
                '</i></h4></center>\n\n<br><br>'))
    }
  }
}

```

<br />

## **Efficiency Indicator Historical Performance** {.tabset}

### Troponin
```{r Troponin historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
cp_stratified_data_for_plots(tat_data = cp_dashboard_tat_filter, test = "Troponin")
```
<h6> *TAT percentages include ED, ICU, and IP Non-ICU labs with valid turnaround times. Resulted volumes include all resulted labs from all settings, including Ambulatory.* </h6>

### Lactate WB
```{r Lactate WB historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
cp_stratified_data_for_plots(tat_data = cp_dashboard_tat_filter, test = "Lactate WB")
```
<h6> *TAT percentages include ED, ICU, and IP Non-ICU labs with valid turnaround times. Resulted volumes include all resulted labs from all settings, including Ambulatory.* </h6>

### BUN
```{r BUN historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
cp_stratified_data_for_plots(tat_data = cp_dashboard_tat_filter, test = "BUN")
```
<h6> *TAT percentages include ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Resulted volumes include all resulted labs from all settings.* </h6>

### HGB
```{r HGB historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
cp_stratified_data_for_plots(tat_data = cp_dashboard_tat_filter, test = "HGB")
```
<h6> *TAT percentages include ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Resulted volumes include all resulted labs from all settings.* </h6>

### PT
```{r PT historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
cp_stratified_data_for_plots(tat_data = cp_dashboard_tat_filter, test = "PT")
```
<h6> *TAT percentages include ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Resulted volumes include all resulted labs from all settings.* </h6>

### Rapid Flu
```{r Rapid Flu historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
cp_stratified_data_for_plots(tat_data = cp_dashboard_tat_filter, test = "Rapid Flu")
```
<h6> *TAT percentages include ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Resulted volumes include all resulted labs from all settings.* </h6>

### C. diff
```{r C. diff historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
cp_stratified_data_for_plots(tat_data = cp_dashboard_tat_filter, test = "C. diff")
```
<h6> *TAT percentages include ED, ICU, and IP Non-ICU labs with valid turnaround times. Resulted volumes include all resulted labs from all settings.* </h6>

### All Breast Specimens
```{r All Breast Specimens historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}

ap_strat_data(ap_hist_30_day_rtr,
              ap_hist_30_day_ctr,
              ap_hist_30_day_vol,
              "Breast")

```

### GI Biopsies
```{r GI Biopsies historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}

ap_strat_data(ap_hist_30_day_rtr,
              ap_hist_30_day_ctr,
              ap_hist_30_day_vol,
              "GI")

```


### Cyto Gyn Specimens
<h4><span style = "color:red">Cyto Gyn Pending - Resolution of Data Issues</h4></span style = "color:red">
```{r Cyto Gyn Specimens historical data, eval = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}

ap_strat_data(ap_hist_30_day_rtr,
              ap_hist_30_day_ctr,
              ap_hist_30_day_vol,
              "CYTO GYN")

```

### Cyto Non-Gyn Specimens
```{r Cyto Non-Gyn Specimens historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}

ap_strat_data(ap_hist_30_day_rtr,
              ap_hist_30_day_ctr,
              ap_hist_30_day_vol,
              "CYTO NONGYN")

```

<br />

## **Control Charts of Non-Compliant Labs** {.tabset}
### Troponin
```{r Troponin p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
cp_stratified_data_for_pcharts(defect_data = cp_dashboard_defect_summary, test = "Troponin")
```
<h6> Control charts includes ED, ICU, and IP Non-ICU labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.


### Lactate WB
```{r Lactate WB p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
cp_stratified_data_for_pcharts(defect_data = cp_dashboard_defect_summary, test = "Lactate WB")
```
<h6> Control charts includes ED, ICU, and IP Non-ICU labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### BUN
```{r BUN p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
cp_stratified_data_for_pcharts(defect_data = cp_dashboard_defect_summary, test = "BUN")
```
<h6> Control charts includes ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### HGB
```{r HGB p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
cp_stratified_data_for_pcharts(defect_data = cp_dashboard_defect_summary, test = "HGB")
```
<h6> Control charts includes ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### PT
```{r PT p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
cp_stratified_data_for_pcharts(defect_data = cp_dashboard_defect_summary, test = "PT")
```
<h6> Control charts includes ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### Rapid Flu
```{r Rapid Flu p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
cp_stratified_data_for_pcharts(defect_data = cp_dashboard_defect_summary, test = "Rapid Flu")
# asis_output('<span style = "color: red">test text</span>')
```
<h6> Control charts includes ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### C. diff
```{r C. diff p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
cp_stratified_data_for_pcharts(defect_data = cp_dashboard_defect_summary, test = "C. diff")
```
<h6> Control charts includes ED, ICU, and IP Non-ICU labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### All Breast Specimens
```{r All Breast Specimens pchart, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", results='asis'}

ap_strat_data_pchart(ap_hist_30_day_defects, "Breast")

```

### GI Biopsies
```{r GI Biopsies  pchart, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", results='asis'}

ap_strat_data_pchart(ap_hist_30_day_defects, "GI")

```

### Cyto Gyn Specimens
<h4><span style = "color:red">Cyto Gyn Pending - Resolution of Data Issues</h4></span style = "color:red">
```{r Cyto Gyn Specimens  pchart, eval = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", results='asis'}

ap_strat_data_pchart(ap_hist_30_day_defects, "CYTO GYN")

```

### Cyto Non-Gyn Specimens
```{r Cyto Non-Gyn Specimens  pchart, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", results='asis'}

ap_strat_data_pchart(ap_hist_30_day_defects, "CYTO NONGYN")

```


<br />

## **Assumptions and Methodology** {.tabset}
### Definitions
<h4><b>Definition table</b></h4>
The table below summarizes the definitions for some of the terminology used in this dashboard for clarification purposes. 

```{r format table for definitions}

definition_table <-
  data.frame(read_excel(reference_file, sheet = "Definitions"),
             stringsAsFactors = FALSE)

definition_table  %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Terminology Used",
                      "Terminology Definition")) %>%
  kable_styling(bootstrap_options = "hover",
                position = "center",
                font_size = 11,
                full_width = FALSE) %>%
  column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white")

```

### Clinical Pathology
The data presented here is based on the compilation of historical data.

<h4><b>Data Sources</b></h4>
MSH and MSQ: Based on daily SCC report. Report name changes daily but follows structure of "DocMM-DD_xxxxxx.xlsx"</br>
MSBI, MSB, MSW, MSM: Based on daily Sunquest report titled "KPI_Daily_TAT_Report_Updated.xls"</br>
The table below summarizes the test codes and IDs used from these daily reports.

```{r Create and format a table for test codes}
test_codes_kable <- test_code %>%
  mutate(Test = factor(Test, levels = cp_micro_lab_order, ordered = TRUE)) %>%
  arrange(Test)

test_codes_kable <-
  test_codes_kable[ , c("Division", "Test", "SCC_TestID", "SUN_TestCode")]

test_codes_kable %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Lab Division",
                      "Test",
                      "SCC Test ID",
                      "Sunquest Test Code")) %>%
  kable_styling(bootstrap_options = "hover",
                position = "center",
                font_size = 11,
                full_width = FALSE) %>%
  column_spec(column = c(1, 2, 3, 4),
              border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13,
           background = "#221f72",
           color = "white") %>%
  collapse_rows()

```

<h4><b>Target Turnaround Times</b></h4>
The table below summarizes target turnaround times as agreed upon by clinical and operational leadership. 
```{r Create and format tables for TAT targets }
tat_targets_kable <- tat_targets %>%
  mutate(Test = factor(Test,
                       levels = cp_micro_lab_order,
                       ordered = TRUE),
         Priority = factor(Priority,
                           levels = dashboard_priority_order,
                           ordered = TRUE)) %>%
  arrange(Test, Priority)

tat_targets_kable$Concate <- NULL

tat_targets_kable %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Test",
                      "Priority",
                      "Patient Setting",
                      "Receive to Result TAT Target (min)",
                      "Collect to Result TAT Target (min)"),
        caption = "Target Turnaround Times") %>%
  kable_styling(bootstrap_options = "hover",
                position = "center",
                font_size = 11,
                full_width = FALSE) %>%
  column_spec(column = c(1, 2, 3, 5),
              border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white")

```

<h4><b>Additional notes on target turnaround times:</b></h4>

* Troponin and Lactate WB:
    + All labs are treated as stat regardless of documented priority and patient setting.
    + Ambulatory labs excluded from turnaround time analysis
* Rapid Flu:
    + All labs are treated as stat regardless of documented priority and patient setting.
* C. diff:
    + All labs are treated as stat regardless of documented priority and patient setting.
    + Turnaround time for ambulatory C. diff tests are not tracked but rather volume of these labs is monitored.

<h4><b>Turnaround Time Exclusions</b></h4>

Turnaround time analysis excludes labs with out of order steps (ie, collect after receive), missing timestamps, add-on orders, and labs not originating in IP, ED, or ambulatory settings (ie, Outreach).

<br>
  
<h4><b>Add On Orders</b></h4>
Add on orders are defined as labs with an order time more than 5 minutes after receive time. These labs are excluded from turnaround time analysis but the volume of these labs is monitored.

<br>

<h4><b>Missing Collections</b></h4>
Labs are classified as missing collections based on the following criteria:

* SCC: Collection time equal to receive time
* Sunquest: Collection time equal to order time

### Anatomic Pathology
The data presented here is based on the compilation of historical data.
<h4><b>Target Turnaround Times</b></h4>
The table below summarizes target turnaround times for Anatomic Pathology as agreed upon by clinical and operational leadership. 

```{r Target Turnaround Times Table}

tat_targets_ap  %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Test",
                      "Patient Setting",
                      "Receive to Result TAT Target (days)",
                      "Collect to Result TAT Target (days)")) %>%
  kable_styling(bootstrap_options = "hover",
                position = "center",
                font_size = 11,
                full_width = FALSE) %>%
  column_spec(column = c(1, 2, 3, 4),
              border_right = "thin solid lightgray") %>%
  row_spec(row = 0,
           font_size = 13,
           background = "#221f72",
           color = "white") %>%
  collapse_rows(columns = 1)

```


<h4><b>Inclusion and Exclusion Criteria for GI Specimens</b></h4>
The table below summarizes the GI codes that were included vs. excluded during the TAT and volume calculations as agreed upon by clinical and operational leadership.
<br>
Only the codes for GI biopsies are included in the analysis.

```{r GI Codes Table}

gi_codes_updated <-
  gi_codes[, c("GI.Codes.Must.Include.in.Analysis..All.GI.Biopsies.",
               "Spec_code")]

gi_codes_updated  %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Specimen Code",
                      "Included vs. Excluded Codes")) %>%
  kable_styling(bootstrap_options = "hover",
                position = "center",
                font_size = 11,
                full_width = FALSE) %>%
  column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13,
           background = "#221f72",
           color = "white") %>%
  collapse_rows(columns = 1)

```

<h4><b>Additional notes on target turnaround times:</b></h4>

* Receive to Result TAT: for anatomic pathology this metric only includes MSHS business days and is a measure of internal laboratory performance.

* Collect to Result TAT: for anatomic pathology this metric includes all calendar days and is a patient-centric measure of performance.

* At this phase, target turnaround times for collect to result have not been established. This metric will be tracked in order to understand current performance and establish future targets.

* Primary Specimens: When a specimen has multiple slides, only the first slide is included. The primary slide is identified as those with spec_sort_order = A.

* All Breast Specimens:
    + Included all the primary breast specimens only. 
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume
    
* GI Biopsies:
    + Included only the samples that are consisted of GI biopsies
    + Only primary specimen GI biopsies included
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume

* Cyto Non-Gyn:
    + Included all primary Cyto non-Gyn specimens
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume
    
### Control Charts of Non-Compliant Labs
These control charts are p-charts used to track non-compliant labs. Non-compliant labs are defined as those labs that do not meet the target turnaround times from receipt in laboratory to result. Only labs with valid turnaround times are included in this analysis. 

Percentage of non-compliant labs calculated as: $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$ 

Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. 

Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$. 

Control charts are generated if and only if the average sample size accross the reported perion is more than or equal to 50 labs. n $\ge$ 50 

<h6> *End of report.* </h6>
